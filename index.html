<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long to Wide Format Converter</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; padding: 20px; background-color: #f0f4f8; font-family: 'Oswald', Arial, sans-serif; color: #000000; font-weight: 500; min-height: 100vh; }
        
        .page-container { width: 100%; max-width: 1200px; margin: 0 auto; }
        
        .page-header { background-color: #004080; color: #ffffff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .logo-box { background: #ffffff; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; }
        .logo-box img { width: 80px; height: auto; border-radius: 6px; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; font-weight: 500; }
        
        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }
        
        .section-header { background-color: #004080; color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #ffffff; color: #004080; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; }
        .section-title { font-size: 16px; font-weight: 700; letter-spacing: 0.5px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: #004080; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-family: 'Oswald', Arial, sans-serif; font-weight: 500; color: #000; background: #ffffff; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .help-text { font-size: 12px; color: #666; margin-top: 5px; font-style: italic; }
        
        .btn-primary { padding: 14px 24px; background: #004080; color: #ffffff; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-primary:hover { background: #0056b3; border-color: #0056b3; }
        .btn-primary:disabled { background: #6c757d; border-color: #6c757d; cursor: not-allowed; }
        .btn-gold { padding: 14px 24px; background: #ffc107; color: #000000; border: 2px solid #ffc107; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-gold:hover { background: #e0a800; border-color: #e0a800; }
        .btn-gold:disabled { background: #ccc; color: #666; border-color: #ccc; cursor: not-allowed; }
        
        .upload-zone { border: 3px dashed #004080; border-radius: 8px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { background: #e7f3ff; border-color: #0056b3; }
        .upload-zone.dragover { background: #d4edda; border-color: #28a745; }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-text { font-size: 16px; color: #004080; font-weight: 600; }
        .upload-hint { font-size: 12px; color: #666; margin-top: 8px; }
        
        .file-info { background: #d4edda; border: 2px solid #28a745; border-radius: 6px; padding: 15px; margin-top: 15px; display: none; }
        .file-info.show { display: block; }
        .file-name { font-weight: 700; color: #155724; }
        .file-details { font-size: 12px; color: #155724; margin-top: 5px; }
        
        .config-section { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .config-title { font-size: 14px; font-weight: 700; color: #004080; margin-bottom: 15px; text-transform: uppercase; }
        
        .pattern-example { background: #1a1a2e; color: #17a2b8; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; margin: 15px 0; line-height: 1.8; }
        .pattern-example .highlight { color: #ffc107; font-weight: bold; }
        .pattern-example .arrow { color: #28a745; }
        .pattern-example .dim { color: #6c757d; }
        
        .unique-values { background: #e7f3ff; border: 1px solid #004080; border-radius: 4px; padding: 10px; margin-top: 10px; max-height: 80px; overflow-y: auto; }
        .unique-values .label { font-size: 11px; color: #004080; font-weight: 600; margin-bottom: 5px; }
        .unique-values .values { font-size: 12px; color: #333; }
        .unique-tag { display: inline-block; background: #fff; border: 1px solid #004080; border-radius: 3px; padding: 2px 8px; margin: 2px; font-size: 11px; }
        
        .column-panel { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; overflow: hidden; margin-top: 15px; }
        .panel-header { background: #004080; color: white; padding: 12px 15px; font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .panel-count { background: #ffffff; color: #004080; padding: 2px 10px; border-radius: 12px; font-size: 11px; }
        .panel-content { max-height: 200px; overflow-y: auto; padding: 10px; }
        .column-item { padding: 8px 12px; margin: 4px 0; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .column-item:hover { background: #e7f3ff; border-color: #004080; }
        .column-item.selected { background: #d4edda; border-color: #28a745; }
        .column-item input { accent-color: #004080; }
        .panel-actions { padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        .panel-btn { flex: 1; padding: 8px; border: 1px solid #004080; background: white; color: #004080; border-radius: 4px; font-family: 'Oswald', Arial, sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; }
        .panel-btn:hover { background: #004080; color: white; }
        .panel-btn.danger { border-color: #dc3545; color: #dc3545; }
        .panel-btn.danger:hover { background: #dc3545; color: white; }
        
        .preview-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .preview-table th { background: #004080; color: white; padding: 10px 8px; text-align: left; font-weight: 600; white-space: nowrap; }
        .preview-table td { padding: 8px; border-bottom: 1px solid #ddd; white-space: nowrap; }
        .preview-table tr:nth-child(even) { background: #f8f9fa; }
        .preview-table tr:hover { background: #e7f3ff; }
        .new-col { background: #d4edda !important; }
        .table-wrapper { overflow-x: auto; max-width: 100%; }
        
        .result-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: 700; color: #004080; }
        .stat-label { font-size: 12px; color: #666; margin-top: 5px; text-transform: uppercase; }
        
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 8px; font-weight: 600; z-index: 2000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .notification.success { background: #d4edda; color: #155724; border: 2px solid #28a745; display: block; }
        .notification.error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; display: block; }
        .notification.info { background: #e7f3ff; color: #004080; border: 2px solid #004080; display: block; }
        
        .page-footer { background-color: #004080; color: #ffffff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; font-weight: 500; border-radius: 0 0 8px 8px; }
        .page-footer p { margin: 6px 0 0; font-size: 12px; }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .form-row, .result-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="logo-row">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                </div>
            </div>
            <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
            <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
            <h1>LONG TO WIDE FORMAT CONVERTER</h1>
            <p class="subtitle">Pivot Long Data into Wide Column Format</p>
        </div>

        <div class="content-card">
            <div class="content-inner">
                <!-- Step 1: Upload -->
                <div class="section-header">
                    <span class="section-icon">1</span>
                    <span class="section-title">UPLOAD DATA FILE</span>
                </div>
                
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Click or drag file here to upload</div>
                    <div class="upload-hint">Supports CSV and Excel files (.csv, .xlsx, .xls)</div>
                </div>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                
                <div class="file-info" id="fileInfo">
                    <span class="file-name" id="fileName"></span>
                    <div class="file-details" id="fileDetails"></div>
                </div>

                <!-- Step 2: Configure Pivot -->
                <div class="section-header hidden" id="step2Header" style="margin-top: 30px;">
                    <span class="section-icon">2</span>
                    <span class="section-title">CONFIGURE PIVOT</span>
                </div>
                
                <div class="hidden" id="step2Content">
                    <div class="config-section">
                        <div class="config-title">Select Columns for Pivot</div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Pivot Column (values become column suffix)</label>
                                <select class="form-select" id="pivotColumn" onchange="updatePreview()">
                                    <option value="">-- Select column --</option>
                                </select>
                                <div class="help-text">e.g., "year" with values 2023, 2024 ‚Üí _2023, _2024</div>
                                <div class="unique-values hidden" id="pivotPreview">
                                    <div class="label">Values found (will become column suffixes):</div>
                                    <div class="values" id="pivotValues"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Value Column (name becomes column prefix)</label>
                                <select class="form-select" id="valueColumn" onchange="updatePreview()">
                                    <option value="">-- Select column --</option>
                                </select>
                                <div class="help-text">e.g., "population" ‚Üí population_2023, population_2024</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Separator</label>
                                <select class="form-select" id="separatorType" onchange="updatePreview()">
                                    <option value="_">Underscore ( _ ) ‚Üí population_2023</option>
                                    <option value="-">Dash ( - ) ‚Üí population-2023</option>
                                    <option value=".">Dot ( . ) ‚Üí population.2023</option>
                                    <option value="">No separator ‚Üí population2023</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Missing Value Fill</label>
                                <select class="form-select" id="fillValue">
                                    <option value="">Empty (blank)</option>
                                    <option value="NA">NA</option>
                                    <option value="0">0</option>
                                    <option value="-">-</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pattern-example" id="transformPreview">
                            <strong>Example:</strong><br><br>
                            <span class="dim">Select pivot and value columns to see preview...</span>
                        </div>
                    </div>
                    
                    <!-- ID Columns Selection -->
                    <div class="column-panel">
                        <div class="panel-header">
                            ID Columns (Keep as Row Identifiers)
                            <span class="panel-count" id="idCount">0</span>
                        </div>
                        <div class="panel-content" id="idColumnsPanel"></div>
                        <div class="panel-actions">
                            <button class="panel-btn" onclick="selectAllId()">Select All</button>
                            <button class="panel-btn danger" onclick="clearAllId()">Clear All</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn-primary" onclick="convertData()">Convert to Wide Format</button>
                    </div>
                </div>

                <!-- Step 3: Preview & Download -->
                <div class="section-header hidden" id="step3Header" style="margin-top: 30px;">
                    <span class="section-icon">3</span>
                    <span class="section-title">PREVIEW & DOWNLOAD</span>
                </div>
                
                <div class="hidden" id="step3Content">
                    <div class="result-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="statInputRows">0</div>
                            <div class="stat-label">Input Rows</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statOutputRows">0</div>
                            <div class="stat-label">Output Rows</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statOutputCols">0</div>
                            <div class="stat-label">Output Columns</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statNewCols">0</div>
                            <div class="stat-label">New Wide Columns</div>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="preview-table" id="previewTable"></table>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                        <button class="btn-gold" onclick="downloadResult('csv')">Download CSV</button>
                        <button class="btn-gold" onclick="downloadResult('xlsx')">Download Excel</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-footer">
            <p style="margin: 0; font-weight: 700;">Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
            <p>Driving Data-Driven Solutions for Health and Development</p>
            <p style="font-size: 10px;">¬© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        let originalData = [];
        let headers = [];
        let idColumns = new Set();
        let convertedData = [];
        let convertedHeaders = [];

        // File Upload
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                showNotification('Please upload a CSV or Excel file', 'error');
                return;
            }

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').classList.add('show');
            
            const reader = new FileReader();
            
            if (fileName.endsWith('.csv')) {
                reader.onload = (e) => parseCSV(e.target.result);
                reader.readAsText(file);
            } else {
                reader.onload = (e) => parseExcel(e.target.result);
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            headers = parseCSVLine(lines[0]);
            originalData = lines.slice(1).map(line => parseCSVLine(line));
            
            document.getElementById('fileDetails').textContent = `${originalData.length} rows √ó ${headers.length} columns`;
            showNotification(`Loaded ${originalData.length} rows`, 'success');
            setupConfiguration();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseExcel(data) {
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            headers = jsonData[0].map(h => String(h || ''));
            originalData = jsonData.slice(1).map(row => 
                headers.map((_, i) => row[i] !== undefined ? String(row[i]) : '')
            );
            
            document.getElementById('fileDetails').textContent = `${originalData.length} rows √ó ${headers.length} columns`;
            showNotification(`Loaded ${originalData.length} rows`, 'success');
            setupConfiguration();
        }

        function setupConfiguration() {
            // Show step 2
            document.getElementById('step2Header').classList.remove('hidden');
            document.getElementById('step2Content').classList.remove('hidden');
            
            // Populate dropdowns
            const pivotSelect = document.getElementById('pivotColumn');
            const valueSelect = document.getElementById('valueColumn');
            
            pivotSelect.innerHTML = '<option value="">-- Select column --</option>';
            valueSelect.innerHTML = '<option value="">-- Select column --</option>';
            
            headers.forEach(col => {
                pivotSelect.innerHTML += `<option value="${col}">${col}</option>`;
                valueSelect.innerHTML += `<option value="${col}">${col}</option>`;
            });
            
            // Auto-detect common patterns
            autoDetectColumns();
            setupIdColumns();
        }

        function autoDetectColumns() {
            const pivotPatterns = ['year', 'period', 'time', 'date', 'month', 'quarter', 'week'];
            const valuePatterns = ['value', 'values', 'amount', 'count', 'total', 'number', 'pop', 'population', 'cases'];
            
            headers.forEach(col => {
                const colLower = col.toLowerCase();
                
                if (pivotPatterns.some(p => colLower.includes(p))) {
                    document.getElementById('pivotColumn').value = col;
                }
                if (valuePatterns.some(p => colLower === p || colLower.includes(p))) {
                    document.getElementById('valueColumn').value = col;
                }
            });
            
            updatePreview();
        }

        function getUniqueValues(colName) {
            const idx = headers.indexOf(colName);
            if (idx === -1) return [];
            
            const unique = new Set();
            originalData.forEach(row => {
                if (row[idx] !== undefined && row[idx] !== '') unique.add(row[idx]);
            });
            return Array.from(unique).sort();
        }

        function updatePreview() {
            const pivotCol = document.getElementById('pivotColumn').value;
            const valueCol = document.getElementById('valueColumn').value;
            const separator = document.getElementById('separatorType').value;
            
            // Show pivot values
            const pivotPreview = document.getElementById('pivotPreview');
            const pivotValuesDiv = document.getElementById('pivotValues');
            
            if (pivotCol) {
                const unique = getUniqueValues(pivotCol);
                pivotPreview.classList.remove('hidden');
                pivotValuesDiv.innerHTML = unique.slice(0, 15).map(v => 
                    `<span class="unique-tag">${v}</span>`
                ).join('') + (unique.length > 15 ? `<span class="unique-tag">+${unique.length - 15} more</span>` : '');
            } else {
                pivotPreview.classList.add('hidden');
            }
            
            // Update ID columns
            setupIdColumns();
            
            // Update transformation preview
            const preview = document.getElementById('transformPreview');
            
            if (!pivotCol || !valueCol) {
                preview.innerHTML = `<strong>Example:</strong><br><br>
                    <span class="dim">Select pivot and value columns to see preview...</span>`;
                return;
            }
            
            const pivotUnique = getUniqueValues(pivotCol).slice(0, 3);
            const newCols = pivotUnique.map(v => `${valueCol}${separator}${v}`);
            const idColsArray = Array.from(idColumns).slice(0, 2);
            
            preview.innerHTML = `<strong>Transformation:</strong><br><br>
                <span class="dim">Long format:</span> ${idColsArray.length > 0 ? idColsArray.join(', ') + ', ' : ''}<span class="highlight">${pivotCol}</span>, <span class="highlight">${valueCol}</span><br><br>
                <span class="arrow">‚Üì converts to ‚Üì</span><br><br>
                <span class="dim">Wide format:</span> ${idColsArray.length > 0 ? idColsArray.join(', ') + ', ' : ''}<span class="highlight">${newCols.join('</span>, <span class="highlight">')}</span>${pivotUnique.length < getUniqueValues(pivotCol).length ? ', ...' : ''}`;
        }

        function setupIdColumns() {
            const pivotCol = document.getElementById('pivotColumn').value;
            const valueCol = document.getElementById('valueColumn').value;
            
            const excludedCols = new Set([pivotCol, valueCol].filter(c => c));
            const availableCols = headers.filter(h => !excludedCols.has(h));
            
            const panel = document.getElementById('idColumnsPanel');
            
            // Remember previous selections
            const previousSelections = new Set(idColumns);
            
            panel.innerHTML = '';
            idColumns.clear();
            
            availableCols.forEach((col, idx) => {
                // By default, select all available columns as ID columns
                const shouldSelect = previousSelections.size === 0 ? true : previousSelections.has(col);
                
                const item = document.createElement('div');
                item.className = 'column-item' + (shouldSelect ? ' selected' : '');
                item.innerHTML = `<input type="checkbox" id="id-${idx}" ${shouldSelect ? 'checked' : ''}> <label for="id-${idx}">${col}</label>`;
                item.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                    updateIdSelection();
                };
                panel.appendChild(item);
                
                if (shouldSelect) {
                    idColumns.add(col);
                }
            });
            
            document.getElementById('idCount').textContent = idColumns.size;
        }

        function updateIdSelection() {
            idColumns.clear();
            
            document.querySelectorAll('#idColumnsPanel .column-item').forEach(item => {
                const cb = item.querySelector('input');
                const label = item.querySelector('label').textContent;
                
                if (cb.checked) {
                    idColumns.add(label);
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            document.getElementById('idCount').textContent = idColumns.size;
            updatePreview();
        }

        function selectAllId() {
            document.querySelectorAll('#idColumnsPanel input').forEach(cb => cb.checked = true);
            updateIdSelection();
        }

        function clearAllId() {
            document.querySelectorAll('#idColumnsPanel input').forEach(cb => cb.checked = false);
            updateIdSelection();
        }

        function convertData() {
            const pivotCol = document.getElementById('pivotColumn').value;
            const valueCol = document.getElementById('valueColumn').value;
            const separator = document.getElementById('separatorType').value;
            const fillValue = document.getElementById('fillValue').value;
            
            if (!pivotCol) {
                showNotification('Please select a Pivot Column', 'error');
                return;
            }
            if (!valueCol) {
                showNotification('Please select a Value Column', 'error');
                return;
            }
            
            const pivotIdx = headers.indexOf(pivotCol);
            const valueIdx = headers.indexOf(valueCol);
            
            const idColsArray = Array.from(idColumns);
            const idIndices = idColsArray.map(c => headers.indexOf(c));
            
            // Get all unique pivot values (these become new column suffixes)
            const pivotUnique = getUniqueValues(pivotCol);
            
            // Build new column names: valueCol_pivotValue (e.g., population_2023)
            const newWideColumns = pivotUnique.map(v => `${valueCol}${separator}${v}`);
            
            // Build converted headers
            convertedHeaders = [...idColsArray, ...newWideColumns];
            
            // Group data by ID columns
            const grouped = new Map();
            
            originalData.forEach(row => {
                // Create key from ID columns
                const keyParts = idIndices.map(i => row[i] || '');
                const key = keyParts.join('|||');
                
                if (!grouped.has(key)) {
                    grouped.set(key, {
                        idValues: keyParts,
                        wideValues: {}
                    });
                }
                
                // Get the pivot value and use it to determine column name
                const pivotValue = row[pivotIdx] || '';
                const wideColName = `${valueCol}${separator}${pivotValue}`;
                
                // Store the actual data value
                grouped.get(key).wideValues[wideColName] = row[valueIdx] || '';
            });
            
            // Convert grouped data to array
            convertedData = [];
            
            grouped.forEach(({ idValues, wideValues }) => {
                const row = [...idValues];
                newWideColumns.forEach(col => {
                    row.push(wideValues[col] !== undefined ? wideValues[col] : fillValue);
                });
                convertedData.push(row);
            });
            
            // Show step 3
            document.getElementById('step3Header').classList.remove('hidden');
            document.getElementById('step3Content').classList.remove('hidden');
            
            // Update stats
            document.getElementById('statInputRows').textContent = originalData.length.toLocaleString();
            document.getElementById('statOutputRows').textContent = convertedData.length.toLocaleString();
            document.getElementById('statOutputCols').textContent = convertedHeaders.length;
            document.getElementById('statNewCols').textContent = newWideColumns.length;
            
            // Build preview table
            const table = document.getElementById('previewTable');
            let html = '<thead><tr>';
            convertedHeaders.forEach((h, i) => {
                const isNew = i >= idColsArray.length;
                html += `<th class="${isNew ? 'new-col' : ''}">${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            const previewRows = convertedData.slice(0, 25);
            previewRows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, i) => {
                    const isNew = i >= idColsArray.length;
                    html += `<td class="${isNew ? 'new-col' : ''}">${cell}</td>`;
                });
                html += '</tr>';
            });
            
            if (convertedData.length > 25) {
                html += `<tr><td colspan="${convertedHeaders.length}" style="text-align:center;color:#666;font-style:italic;">... and ${convertedData.length - 25} more rows</td></tr>`;
            }
            
            html += '</tbody>';
            table.innerHTML = html;
            
            showNotification(`Converted: ${originalData.length} rows ‚Üí ${convertedData.length} rows √ó ${convertedHeaders.length} columns`, 'success');
            
            // Scroll to results
            document.getElementById('step3Header').scrollIntoView({ behavior: 'smooth' });
        }

        function downloadResult(format) {
            if (convertedData.length === 0) {
                showNotification('No data to download. Please convert first.', 'error');
                return;
            }
            
            if (format === 'csv') {
                let csv = convertedHeaders.map(h => `"${h}"`).join(',') + '\n';
                convertedData.forEach(row => {
                    csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                downloadBlob(blob, 'wide_format_data.csv');
            } else {
                const wb = XLSX.utils.book_new();
                const wsData = [convertedHeaders, ...convertedData];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Wide Format');
                XLSX.writeFile(wb, 'wide_format_data.xlsx');
            }
            
            showNotification(`Downloaded as ${format.toUpperCase()}`, 'success');
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            setTimeout(() => { notification.className = 'notification'; }, 4000);
        }
    </script>
</body>
</html>
